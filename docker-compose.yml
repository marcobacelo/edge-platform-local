services:
  localstack:
    image: localstack/localstack:3
    container_name: localstack
    environment:
      - SERVICES=sqs,dynamodb
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=eu-west-1
    ports:
      - "4566:4566"
    healthcheck:
      test: ["CMD", "awslocal", "sqs", "list-queues"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - ./infra/bootstrap.sh:/etc/localstack/init/ready.d/bootstrap.sh:ro

  api:
    container_name: api
    build: ./apps/api
    ports:
      - "3000:3000"
    environment:
      AWS_REGION: eu-west-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      DDB_ENDPOINT: http://localstack:4566
      DDB_TABLE: PhoneNumbers
    depends_on:
      localstack:
        condition: service_healthy
    # ðŸ”¹ pequena espera opcional para garantir que o bootstrap jÃ¡ rodou
    command: sh -c "sleep 5 && node dist/main.js"

  generator:
    container_name: generator
    build: ./apps/generator
    environment:
      AWS_REGION: eu-west-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      SQS_ENDPOINT: http://localstack:4566
      NUMBERS_QUEUE_URL: http://localstack:4566/000000000000/numbers.fifo
      BATCH_SIZE: 200
    depends_on:
      localstack:
        condition: service_healthy

  enricher:
    container_name: enricher
    build: ./apps/enricher
    environment:
      AWS_REGION: eu-west-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      SQS_ENDPOINT: http://localstack:4566
      NUMBERS_QUEUE_URL: http://localstack:4566/000000000000/numbers.fifo
      ENRICHED_QUEUE_URL: http://localstack:4566/000000000000/enriched.fifo
    depends_on:
      localstack:
        condition: service_healthy

  persister:
    container_name: persister
    build: ./apps/persister
    environment:
      AWS_REGION: eu-west-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      SQS_ENDPOINT: http://localstack:4566
      ENRICHED_QUEUE_URL: http://localstack:4566/000000000000/enriched.fifo
      DDB_ENDPOINT: http://localstack:4566
      DDB_TABLE: PhoneNumbers
    depends_on:
      localstack:
        condition: service_healthy
